<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>MBTA Stop Predictions - skyqrose</title>
    <script src="/js/elm.js"></script>
</head>

<body>
    <noscript>
        JavaScript is required for this page
    </noscript>
    <script>
        var api_key = "3a6d67c08111426d8617a30340a9fad3";
        var eventNames = ["reset", "add", "update", "remove"];
        app = Elm.Main.init();
        app.ports.predictionStreamJson.subscribe(function (stop) {
            var url = ("https://api-v3.mbta.com/predictions"
                + "?api_key=" + api_key
                + "&filter[route]=" + stop.route_id
                + "&filter[stop]=" + stop.stop_id
            );
            var eventSource = new EventSource(url);
            for (i = 0; i < eventNames.length; i++) {
                let eventName = eventNames[i];
                console.log("adding " + eventName);
                eventSource.addEventListener(eventName, function (eventData) {
                    console.log(eventName);
                    console.log(stop);
                    console.log(eventData);
                    app.ports.predictionEvent.send({
                        event: eventName,
                        stop: stop,
                        data: JSON.parse(eventData.data),
                    });
                }, false);
            }
            console.log("watching");
            console.log(stop);
        })
    </script>
</body>

</html>
